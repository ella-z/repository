# 埋点
## 埋点与前端监控
- 前端监控的作用最主要的就是采集用户行为，跟踪产品在客户端的使用情况，后期可以根据这些数据来分析产品，对产品进行一个优化。
- 埋点就是实现前端监控的一种方法。
### 前端监控
- 前端监控分为三种：数据监控、性能监控、异常监控。
   - 数据监控就是监听用户的行为，例如：
      - 监控页面的点击量、浏览量，某个站点或点击某条新闻的不同IP地址的人数。
      - 用户在每个页面的停留时间。
      - 用户通过什么入口来访问页面。
      - 用户浏览视频的时间。
      - 用户在相应的页面中触发的行为。
      .....
   - 性能监控就是监听前端的性能，主要包括监听网页或者说产品在用户端的体验。常见的性能监控包括：
      - 不同用户、不同机型、不同系统下的首屏加载时间
      - 白屏时间
      - http等待请求的时间
      - 静态资源整体下载时间
      - 页面渲染时间
      - 页面交互动画完成时间
      ......
   - 异常监控，由于产品的前端代码在执行过程中也会发生异常，因此需要引入异常监控。及时的上报异常情况，可以避免线上故障的发上。虽然大部分异常可以通过 try catch 的方式捕获，但是比如内存泄漏以及其他偶现的异常难以捕获。常见的需要监控的异常包括：
      - Javascript 的异常监控
      - 样式丢失的异常监控
### 前端埋点
- 前端埋点分为三类：手动埋点、可视化埋点、无埋点。
#### 手动埋点
- 手动埋点，也叫代码埋点，即纯手动写代码，调用埋点 SDK 的函数，在需要埋点的业务逻辑功能位置调用接口，上报埋点数据。
#### 可视化埋点
- 通过可视化交互的手段，代替上述的代码埋点。将业务代码和埋点代码分离，提供一个可视化交互的页面，输入为业务代码，通过这个可视化系统，可以在业务代码中自定义的增加埋点事件等等，最后输出的代码耦合了业务代码和埋点代码。缺点就是可以埋点的控件有限，不能手动定制。
#### 无埋点
- 无埋点则是前端自动采集全部事件，上报埋点数据，由后端来过滤和计算出有用的数据。优点是前端只要一次加载埋点脚本，缺点是流量和采集的数据过于庞大，服务器性能压力山大。

## 埋点的实践
1. 通过浏览器内置的JavaScript对象(例如，window、document、navigator)，可以收集一些用户的基本信息(例如，document.domain：域名、document.URL：当前URL地址、window.screen.height：屏幕高度)，再通过image对象或者iframe对象的src进行传递，避免跨域的问题。
2. 通过script引入第三方埋点的代码。
3. 通过IntersectionObserver接口实现，IntersectionObserver接口提供了一种异步观察目标元素与其祖先元素或顶级文档视窗交叉状态的方法。祖先元素与视窗被称为根。
   - 注意：当一个IntersectionObserver对象被创建时，其被配置为监听根中一段给定比例的可见区域。一旦IntersectionObserver被创建，则无法更改其配置，所以一个给定的观察者对象只能用来监听可见区域的特定变化值；然而，你可以在同一个观察者对象中配置监听多个目标元素。
   - 当监控元素进入视窗时与出视窗时都会触发callback函数，通过这个特性，我们可以检测用户在某个特定的元素停留的时间、用户观看视频的时间、统计浏览量等等。



### 参考
- [前端埋点和前端监控](https://zhuanlan.zhihu.com/p/65834362)
- [Intersection Observer](https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver)


